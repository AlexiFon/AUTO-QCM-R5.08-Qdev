{% extends 'base.html' %}

{% load latexify %}

{% block content %}
  {% include 'latexify/stylesheets.html' %}
  <style>
    .hidden {
      display: none;
    }

    .form-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }
  </style>

  <div class="container mt-4">
    <h2>
      {% if question.pk %}
        Modifier la Question
      {% else %}
        Créer une Nouvelle Question
      {% endif %}
    </h2>

    <!-- Affichage des erreurs -->
    {% if form.errors or formset.errors %}
      <div class="alert alert-danger">
        <ul>
          {% for field in form %}
            {% if field.errors %}
              {% for error in field.errors %}
                <li>{{ error }}</li>
              {% endfor %}
            {% endif %}
          {% endfor %}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
          {% for formset_form in formset %}
            {% if formset_form.errors %}
              {% for field, errors in formset_form.errors.items %}
                <li>{{ field }}: {{ errors|join:', ' }}</li>
              {% endfor %}
            {% endif %}
          {% endfor %}
          {% for error in formset.non_form_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post" id="questionForm">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ next }}" />

      <!-- Étape 1 : Informations générales -->
      <div class="step active" id="step-1">
        <h3>Étape 1 : Informations générales</h3>
        <div class="form-group">{{ form.nom.label_tag }} {{ form.nom }}</div>
        <div class="form-group">{{ form.texte.label_tag }} {{ form.texte }}</div>
        <div class="form-group">{{ form.note.label_tag }} {{ form.note }}</div>
        <div class="form-group">{{ form.tags.label_tag }} {{ form.tags }}</div>
        <div class="form-group">
          <label for="new_tags">Ajouter de nouveaux tags :</label>
          <div id="newTagsContainer"></div>
          <button type="button" id="addNewTag" class="btn btn-sm btn-outline-primary">+</button>
        </div>
      </div>

      <!-- Étape 2 : Options avancées -->
      <div class="step" id="step-2">
        <h3>Étape 2 : Options avancées</h3>
        <div class="form-group">{{ form.melange_rep.label_tag }} {{ form.melange_rep }}</div>
        <div>
          <label for="preview">Preview LaTeX :</label>
          <div id="copy_text"></div>
        </div>
      </div>

      <!-- Étape 3 : Réponses -->
      <div class="step" id="step-3">
        <h3>Étape 3 : Réponses</h3>
        <div id="reponseFormset">
          {{ formset.management_form }}
          {% for formset_form in formset %}
            <div class="formset_row border rounded position-relative">
              {{ formset_form.as_p }}
              <button type="button" class="btn btn-danger btn-sm removeReponse position-absolute">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          {% endfor %}
        </div>

        <div id="reponseVide" class="hidden">
          {{ formset.empty_form.as_p }}
          <button type="button" class="btn btn-danger btn-sm removeReponse position-absolute">
            <i class="bi bi-trash"></i>
          </button>
        </div>

        <button type="button" id="addReponse" class="btn btn-sm btn-outline-primary">Ajouter une réponse</button>
      </div>

      <!-- Navigation -->
      <div class="form-navigation">
        <button type="button" id="prevStep" class="btn btn-outline-primary hidden">Étape précédente</button>
        <button type="button" id="nextStep" class="btn btn-outline-primary">Étape suivante</button>
        <button type="submit" class="btn btn-success hidden" id="submitForm">
          {% if question.pk %}
            Enregistrer les modifications
          {% else %}
            Créer la question
          {% endif %}
        </button>
      </div>
    </form>
  </div>

  {% include 'latexify/scripts.html' %}
{% endblock %}

{% block extra_scripts %}
  <script>
    $(document).ready(function () {
      let currentStep = 1;
      const totalSteps = 3;

      function updateStep() {
        $(".step").removeClass("active");
        $(`#step-${currentStep}`).addClass("active");

        // Show/hide navigation buttons
        $("#prevStep").toggleClass("hidden", currentStep === 1);
        $("#nextStep").toggleClass("hidden", currentStep === totalSteps);
        $("#submitForm").toggleClass("hidden", currentStep !== totalSteps);
      }

      $("#nextStep").click(function () {
        if (currentStep < totalSteps) currentStep++;
        updateStep();
      });

      $("#prevStep").click(function () {
        if (currentStep > 1) currentStep--;
        updateStep();
      });

      // Dynamique pour le formset et les tags
      // (ajoutez ici la logique existante pour LaTeX et les réponses dynamiques)
    });
  </script>
{% endblock %}
